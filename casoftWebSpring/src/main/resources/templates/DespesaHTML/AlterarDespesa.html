<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Editar Despesa</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="../css/estilo.css" rel="stylesheet">
  <style>
    .required { color: red; }
    .card-section { 
      background-color: #f8f9fa;
      border-radius: 8px;
      padding: 20px;
      margin-bottom: 20px;
    }
    .section-title {
      color: #2c3e50;
      border-bottom: 1px solid #dee2e6;
      padding-bottom: 10px;
      margin-bottom: 20px;
    }
  </style>
</head>
<body class="bg-light">
  <!-- Header fixo -->
  <header class="header">
    <div class="container">
      <div class="header-container d-flex align-items-center">
        <button class="menu-toggle d-md-none" id="menu-toggle">
          <span></span>
          <span></span>
          <span></span>
        </button>
        <img src="../img/logo.png" alt="Logo">
        <button id="btnLogout" onclick="authManager.logout()" class="btn btn-danger ml-auto">Deslogar</button>
      </div>
    </div>
  </header>

  <!-- Overlay escuro -->
  <div class="overlay" id="overlay"></div>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <h4 class="p-3">Menu</h4>
    <a href="../home.html">Home</a>
    <a href="../ParametrizacaoHTML/cadastroEmpresa.html">Empresa</a>
    <a href="../EventoHTML/homeEvento.html">Eventos</a>
    <a href="../TipoReceitasHTML/homeTPReceita.html">Tipos de Receita</a>
    <a href="../TipoDespesasHTML/tipoDespesa.html">Tipos de Despesas</a>
    <a href="#">Relatórios</a>
    <a href="#">Configurações</a>
    <a href="../gerenciarContas.html">Contas Bancárias</a>
    <a href="#" id="lancarDespesaToggle">Despesa ▼</a>
    <a hhref="ListarDespesa.html">Despesa</a>
  </div>

  <!-- Conteúdo principal -->
  <div class="content" id="content">
    <div class="container mt-5 mb-5">
      <div class="row justify-content-center">
        <div class="col-lg-9 col-md-10">
          <div class="card form-card">
            <div class="card-body p-3" style="margin: 10px;">
              <div class="d-flex justify-content-between align-items-center mb-4">
                <h3 class="mb-0">Editar Despesa</h3>
                <a href="listaDespesas.html" class="btn btn-secondary">Voltar</a>
              </div>
              
              <form method="POST" id="formEditarDespesa" enctype="multipart/form-data" onsubmit="return atualizarDespesa(event)">
                <input type="hidden" id="despesa_id" name="id">
                
                <!-- Categoria e Descrição -->
                <div class="card-section">
                  <h5 class="section-title">Descrição</h5>
                  <div class="row mb-3">
                    <div class="col-md-8">
                      <label for="categoriadespesa_catdesp_id" class="form-label">Categoria da Despesa <span class="required">*</span></label>
                      <select id="categoriadespesa_catdesp_id" name="tipoDespesa_id" class="form-select" required>
                        <option value="">Carregando categorias...</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="despesa_desc" class="form-label">Descrição</label>
                    <textarea id="despesa_desc" name="descricao" class="form-control" rows="3" placeholder="Descrição detalhada da despesa..."></textarea>
                  </div>
                </div>
                
                <!-- Dados da Despesa -->
                <div class="card-section">
                  <h5 class="section-title">Informações da Despesa</h5>
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="despesa_val" class="form-label">Valor <span class="required">*</span></label>
                      <input type="number" id="despesa_val" name="valor" class="form-control" step="0.01" min="0" placeholder="0,00" required>
                    </div>
                    <div class="col-md-6">
                      <label for="despesa_val_pago" class="form-label">Valor Pago</label>
                      <input type="number" id="despesa_val_pago" name="pagamento" class="form-control" step="0.01" min="0" placeholder="0,00">
                      <small class="text-muted">Se não pago, deixe vazio ou 0</small>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="despesa_dt_venc" class="form-label">Data de Vencimento <span class="required">*</span></label>
                      <input type="date" id="despesa_dt_venc" name="data_venc" class="form-control" required>
                    </div>
                    <div class="col-md-6">
                      <label for="despesa_statuspag" class="form-label">Status do Pagamento <span class="required">*</span></label>
                      <select id="despesa_statuspag" name="status_pagamento" class="form-select" required>
                        <option value="Pendente">Pendente</option>
                        <option value="Pago">Pago</option>
                        <option value="Cancelado">Cancelado</option>
                      </select>
                    </div>
                  </div>
                  
                  <div class="row mb-3">
                    <div class="col-md-6">
                      <label for="despesa_dt_pag" class="form-label">Data de Pagamento</label>
                      <input type="date" id="despesa_dt_pag" name="data_pagamento" class="form-control">
                    </div>
                    <div class="col-md-6">
                      <label for="despesa_statusconci" class="form-label">Status da Conciliação <span class="required">*</span></label>
                      <select id="despesa_statusconci" name="status_conci" class="form-select" required>
                        <option value="Pendente">Pendente</option>
                        <option value="Conciliado">Conciliado</option>
                        <option value="Cancelado">Cancelado</option>
                      </select>
                    </div>
                  </div>
                </div>
                
                <!-- Evento (Opcional) -->
                <div class="card-section">
                  <h5 class="section-title">Associação a Evento (Opcional)</h5>
                  <div class="mb-3">
                    <div class="col-md-8">
                      <label for="evento_evento_id" class="form-label">Evento Relacionado</label>
                      <select id="evento_evento_id" name="evento_id" class="form-select">
                        <option value="">Carregando eventos...</option>
                      </select>
                      <small class="text-muted">Selecione um evento se esta despesa estiver relacionada</small>
                    </div>
                  </div>
                </div>
                
                <!-- Botões -->
                <div class="row mt-4">
                  <div class="col-md-6 mb-2">
                    <button type="button" class="btn btn-secondary w-100" onclick="limparFormularioDespesa()">Limpar</button>
                  </div>
                  <div class="col-md-6 mb-2">
                    <button type="submit" class="btn btn-primary w-100">Atualizar Despesa</button>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
  <script src="../js/authManager.js"></script>
  <script src="../js/authenticatedClient.js"></script>
  <script src="../js/tokenVerification.js"></script>
  
  <script>
    // Carregar categorias de despesas
    async function carregarCategorias() {
      try {
        const response = await authenticatedClient.get('/tipos-despesas');
        const select = document.getElementById('categoriadespesa_catdesp_id');
        
        select.innerHTML = '<option value="">Selecione uma categoria</option>';
        response.data.forEach(categoria => {
          const option = document.createElement('option');
          option.value = categoria.id;
          option.textContent = categoria.nome;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar categorias:', error);
      }
    }

    // Carregar eventos
    async function carregarEventos() {
      try {
        const response = await authenticatedClient.get('/eventos');
        const select = document.getElementById('evento_evento_id');
        
        select.innerHTML = '<option value="">Nenhum evento selecionado</option>';
        response.data.forEach(evento => {
          const option = document.createElement('option');
          option.value = evento.id;
          option.textContent = evento.nome;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Erro ao carregar eventos:', error);
      }
    }

    // Carregar dados da despesa para edição
    async function carregarDespesa() {
      const urlParams = new URLSearchParams(window.location.search);
      const despesaId = urlParams.get('id');
      
      if (!despesaId) {
        alert('Nenhuma despesas selecionada para edição');
        window.location.href = 'listarDespesas.html';
        return;
      }
      
      try {
        const response = await authenticatedClient.get(`/despesas/${despesaId}`);
        const despesa = response.data;
        
        // Preencher formulário
        document.getElementById('despesa_id').value = despesas.id;
        document.getElementById('categoriadespesa_catdesp_id').value = despesas.tipoDespesa_id;
        document.getElementById('despesa_desc').value = despesas.descricao;
        document.getElementById('despesa_val').value = despesas.valor;
        document.getElementById('despesa_val_pago').value = despesas.pagamento || '';
        document.getElementById('despesa_dt_venc').value = despesas.data_venc.split('T')[0];
        document.getElementById('despesa_statuspag').value = despesas.status_pagamento || 'Pendente';
        document.getElementById('despesa_dt_pag').value = despesas.data_pagamento ? despesas.data_pagamento.split('T')[0] : '';
        document.getElementById('despesa_statusconci').value = despesas.status_conci || 'Pendente';
        document.getElementById('evento_evento_id').value = despesas.evento_id || '';
        
      } catch (error) {
        console.error('Erro ao carregar despesas:', error);
        alert('Não foi possível carregar os dados da despesas');
        window.location.href = 'ListarDespesa.html';
      }
    }

    // Atualizar despesa
    async function atualizarDespesa(event) {
      event.preventDefault();
      
      const despesaId = document.getElementById('despesa_id').value;
      const formData = {
        tipoDespesa_id: document.getElementById('categoriadespesa_catdesp_id').value,
        descricao: document.getElementById('despesa_desc').value,
        valor: parseFloat(document.getElementById('despesa_val').value),
        pagamento: parseFloat(document.getElementById('despesa_val_pago').value) || 0,
        data_venc: document.getElementById('despesa_dt_venc').value,
        status_pagamento: document.getElementById('despesa_statuspag').value,
        data_pagamento: document.getElementById('despesa_dt_pag').value || null,
        status_conci: document.getElementById('despesa_statusconci').value,
        evento_id: document.getElementById('evento_evento_id').value || null
      };
      
      try {
        await authenticatedClient.put(`/despesas/${despesaId}`, formData);
        alert('Despesa atualizada com sucesso!');
        window.location.href = 'listaDespesas.html';
      } catch (error) {
        console.error('Erro ao atualizar despesas:', error);
        alert('Erro ao atualizar despesas');
      }
    }

    // Limpar formulário
    function limparFormularioDespesa() {
      document.getElementById('formEditarDespesa').reset();
    }

    // Inicializar quando o DOM estiver pronto
    document.addEventListener('DOMContentLoaded', function() {
      carregarCategorias();
      carregarEventos();
      carregarDespesa();
    });
  </script>
</body>
</html>